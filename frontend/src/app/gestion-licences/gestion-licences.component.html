<div class="gestion-licences-container">
  <h2>Gestion des Licences</h2>

  <!-- Message d'alerte -->
  <div *ngIf="message" class="alert" [ngClass]="'alert-' + messageType">
    {{ message }}
  </div>

  <!-- Statistiques -->
  <div *ngIf="statistics" class="statistics-section">
    <h3>Statistiques</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number">{{ statistics.totalLicenses }}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ statistics.activeLicenses }}</div>
        <div class="stat-label">Actives</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ statistics.inactiveLicenses }}</div>
        <div class="stat-label">Inactives</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ statistics.trialLicenses }}</div>
        <div class="stat-label">Essais</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ statistics.expiredLicenses }}</div>
        <div class="stat-label">Expirées</div>
      </div>
    </div>
  </div>

  <!-- Barre d'actions -->
  <div class="actions-bar">
    <button class="btn btn-primary" (click)="showCreateForm()">
      Nouvelle Licence
    </button>
    <button class="btn btn-secondary" (click)="showValidationDialog()">
      Valider une Licence
    </button>
    <button class="btn btn-info" (click)="loadLicenses()">
      Actualiser
    </button>
  </div>

  <!-- Filtres et recherche -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="search">Recherche :</label>
      <input 
        type="text" 
        id="search"
        [(ngModel)]="searchTerm" 
        (input)="onSearchChange()"
        placeholder="Nom, client, organisation, clé..."
        class="form-control">
    </div>
    
    <div class="filter-group">
      <label for="filterType">Type :</label>
      <select 
        id="filterType"
        [(ngModel)]="filterType" 
        (change)="onFilterChange()"
        class="form-control">
        <option value="ALL">Tous</option>
        <option value="STANDARD">Standard</option>
        <option value="PREMIUM">Premium</option>
        <option value="ENTERPRISE">Enterprise</option>
        <option value="TRIAL">Essai</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="filterStatus">Statut :</label>
      <select 
        id="filterStatus"
        [(ngModel)]="filterStatus" 
        (change)="onFilterChange()"
        class="form-control">
        <option value="ALL">Tous</option>
        <option value="ACTIVE">Actives</option>
        <option value="INACTIVE">Inactives</option>
        <option value="EXPIRED">Expirées</option>
        <option value="TRIAL">Essais</option>
      </select>
    </div>
  </div>

  <!-- Liste des licences -->
  <div class="licences-list">
    <div *ngIf="filteredLicenses.length === 0" class="no-data">
      Aucune licence trouvée.
    </div>
    
    <div *ngFor="let license of filteredLicenses" class="licence-card">
      <div class="licence-header">
        <h4>{{ license.licenseName }}</h4>
        <span class="licence-status" [ngClass]="getStatusClass(license)">
          {{ getStatusText(license) }}
        </span>
      </div>
      
      <div class="licence-details">
        <div class="detail-row">
          <span class="label">Clé :</span>
          <span class="value">{{ license.licenseKey }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Type :</span>
          <span class="value">{{ license.licenseType }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Client :</span>
          <span class="value">{{ license.customerName }}</span>
        </div>
        <div class="detail-row" *ngIf="license.organization">
          <span class="label">Organisation :</span>
          <span class="value">{{ license.organization }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Email :</span>
          <span class="value">{{ license.customerEmail }}</span>
        </div>
        <div class="detail-row" *ngIf="license.maxUsers">
          <span class="label">Max Utilisateurs :</span>
          <span class="value">{{ license.maxUsers }}</span>
        </div>
        <div class="detail-row" *ngIf="license.maxProjects">
          <span class="label">Max Projets :</span>
          <span class="value">{{ license.maxProjects }}</span>
        </div>
        <div class="detail-row" *ngIf="license.comparisonType">
          <span class="label">Type de comparaison :</span>
          <span class="value">
            <span class="comparison-type-badge" [ngClass]="getComparisonTypeBadgeClass(license.comparisonType)">
              {{ comparisonTypeLabels[license.comparisonType] }}
            </span>
          </span>
        </div>
        <div class="detail-row">
          <span class="label">Expiration :</span>
          <span class="value" [ngClass]="getDaysUntilExpiryClass(license.daysUntilExpiry)">
            {{ formatDate(license.expiryDate) }}
            <span *ngIf="license.daysUntilExpiry !== undefined">
              ({{ license.daysUntilExpiry }} jours)
            </span>
          </span>
        </div>
        <div class="detail-row" *ngIf="license.features && license.features.length > 0">
          <span class="label">Fonctionnalités :</span>
          <span class="value">
            <span *ngFor="let feature of license.features; let last = last" class="feature-tag">
              {{ feature }}<span *ngIf="!last">, </span>
            </span>
          </span>
        </div>
      </div>
      
      <div class="licence-actions">
        <button class="btn btn-sm btn-primary" (click)="showEditForm(license)">
          Modifier
        </button>
        <button 
          class="btn btn-sm" 
          [ngClass]="license.isActive ? 'btn-warning' : 'btn-success'"
          (click)="toggleLicenseStatus(license)">
          {{ license.isActive ? 'Désactiver' : 'Activer' }}
        </button>
        <button class="btn btn-sm btn-danger" (click)="deleteLicense(license)">
          Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Formulaire de création/modification -->
  <div *ngIf="showForm" class="modal-overlay" (click)="hideForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editingLicense ? 'Modifier' : 'Créer' }} une Licence</h3>
        <button class="btn-close" (click)="hideForm()">&times;</button>
      </div>
      
      <div class="modal-body">
        <form (ngSubmit)="saveLicense()">
          <div class="form-group">
            <label for="licenseName">Nom de la licence *</label>
            <input 
              type="text" 
              id="licenseName"
              [(ngModel)]="newLicense.licenseName" 
              name="licenseName"
              required
              class="form-control">
          </div>
          
          <div class="form-group">
            <label for="licenseType">Type de licence *</label>
            <select 
              id="licenseType"
              [(ngModel)]="newLicense.licenseType" 
              name="licenseType"
              required
              class="form-control">
              <option *ngFor="let type of licenseTypes" [value]="type">{{ type }}</option>
            </select>
          </div>

          
          
          <div class="form-group">
            <label for="customerName">Nom du client *</label>
            <input 
              type="text" 
              id="customerName"
              [(ngModel)]="newLicense.customerName" 
              name="customerName"
              required
              class="form-control">
          </div>
          
          <div class="form-group">
            <label for="customerEmail">Email du client *</label>
            <input 
              type="email" 
              id="customerEmail"
              [(ngModel)]="newLicense.customerEmail" 
              name="customerEmail"
              required
              class="form-control">
          </div>
          
          <div class="form-group">
            <label for="organization">Projets</label>
            <input 
              type="text" 
              id="organization"
              [(ngModel)]="newLicense.organization" 
              name="organization"
              class="form-control">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="maxUsers">Max Utilisateurs</label>
              <input 
                type="number" 
                id="maxUsers"
                [(ngModel)]="newLicense.maxUsers" 
                name="maxUsers"
                min="1"
                class="form-control">
            </div>
            
            <div class="form-group">
              <label for="maxProjects">Max Projets</label>
              <input 
                type="number" 
                id="maxProjects"
                [(ngModel)]="newLicense.maxProjects" 
                name="maxProjects"
                min="1"
                class="form-control">
            </div>
          </div>
          
          <div class="form-group">
            <label for="expiryDate">Date d'expiration</label>
            <input 
              type="date" 
              id="expiryDate"
              [(ngModel)]="newLicense.expiryDate" 
              name="expiryDate"
              class="form-control">
          </div>
          
          <div class="form-group">
            <label>Fonctionnalités</label>
            <div class="features-grid">
              <div *ngFor="let feature of availableFeatures" class="feature-checkbox">
                <input 
                  type="checkbox" 
                  [id]="'feature-' + feature"
                  [checked]="isFeatureSelected(feature)"
                  (change)="toggleFeature(feature)">
                <label [for]="'feature-' + feature">{{ feature }}</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea 
              id="notes"
              [(ngModel)]="newLicense.notes" 
              name="notes"
              rows="3"
              class="form-control"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              {{ editingLicense ? 'Mettre à jour' : 'Créer' }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="hideForm()">
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Dialogue de validation -->
  <div *ngIf="showValidationForm" class="modal-overlay" (click)="hideValidationDialog()">
    <div class="modal-content validation-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Validation de Licence</h3>
        <button class="btn-close" (click)="hideValidationDialog()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="validationKey">Clé de licence</label>
          <input 
            type="text" 
            id="validationKey"
            [(ngModel)]="validationKey" 
            placeholder="XXXX-XXXX-XXXX-XXXX"
            class="form-control">
        </div>
        
        <div class="form-actions">
          <button class="btn btn-primary" (click)="validateLicense()">
            Valider
          </button>
          <button class="btn btn-secondary" (click)="hideValidationDialog()">
            Fermer
          </button>
        </div>
        
        <div *ngIf="validationResult" class="validation-result">
          <h4>Résultat de la validation</h4>
          <div class="result-status" [ngClass]="validationResult.valid ? 'valid' : 'invalid'">
            {{ validationResult.message }}
          </div>
          
          <div *ngIf="validationResult.license" class="license-info">
            <h5>Informations de la licence</h5>
            <div class="detail-row">
              <span class="label">Nom :</span>
              <span class="value">{{ validationResult.license.licenseName }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Type :</span>
              <span class="value">{{ validationResult.license.licenseType }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Client :</span>
              <span class="value">{{ validationResult.license.customerName }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Expiration :</span>
              <span class="value">{{ formatDate(validationResult.license.expiryDate) }}</span>
            </div>
            <div class="detail-row" *ngIf="validationResult.license.comparisonType">
              <span class="label">Type de comparaison :</span>
              <span class="value">
                <span class="comparison-type-badge" [ngClass]="getComparisonTypeBadgeClass(validationResult.license.comparisonType)">
                  {{ comparisonTypeLabels[validationResult.license.comparisonType] }}
                </span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Styles pour les badges de type de comparaison */
.comparison-type-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-xml {
  background-color: #e3f2fd;
  color: #1976d2;
  border: 1px solid #bbdefb;
}

.badge-json {
  background-color: #f3e5f5;
  color: #7b1fa2;
  border: 1px solid #ce93d8;
}

.badge-pdf {
  background-color: #ffebee;
  color: #d32f2f;
  border: 1px solid #ffcdd2;
}

.badge-default {
  background-color: #f5f5f5;
  color: #666;
  border: 1px solid #ddd;
}

/* Styles pour le formulaire */
.form-text {
  color: #6c757d;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

.form-row {
  display: flex;
  gap: 1rem;
}

.form-row .form-group {
  flex: 1;
}

/* Styles pour les statuts */
.status-active {
  background-color: #d4edda;
  color: #155724;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875rem;
}

.status-expired {
  background-color: #f8d7da;
  color: #721c24;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875rem;
}

.status-inactive {
  background-color: #fff3cd;
  color: #856404;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875rem;
}

.status-trial {
  background-color: #d1ecf1;
  color: #0c5460;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.875rem;
}

/* Classes utilitaires pour les couleurs de texte */
.text-danger {
  color: #dc3545 !important;
}

.text-warning {
  color: #ffc107 !important;
}

.text-success {
  color: #28a745 !important;
}

/* Styles pour les features */
.feature-tag {
  display: inline-block;
  background-color: #e9ecef;
  color: #495057;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.875rem;
  margin-right: 4px;
}

/* Grille des features dans le formulaire */
.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.feature-checkbox {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.feature-checkbox input[type="checkbox"] {
  margin: 0;
}

.feature-checkbox label {
  margin: 0;
  font-size: 0.875rem;
  cursor: pointer;
}

/* Styles pour la validation */
.validation-result {
  margin-top: 1rem;
  padding: 1rem;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  background-color: #f8f9fa;
}

.result-status.valid {
  color: #28a745;
  font-weight: 600;
  margin-bottom: 1rem;
}

.result-status.invalid {
  color: #dc3545;
  font-weight: 600;
  margin-bottom: 1rem;
}

.license-info {
  margin-top: 1rem;
}

.license-info h5 {
  margin-bottom: 0.5rem;
  color: #495057;
}
</style>